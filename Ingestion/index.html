<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload & Summarize</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <!-- Markdown + sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.6); }
    .dark .glass { background: rgba(0,0,0,0.35); }
    .fade-in { animation: fade 0.35s ease-out both; }
    @keyframes fade { from{opacity:0; transform: translateY(6px);} to{opacity:1; transform: translateY(0);} }

    /* Card pop */
    .card-pop { transition: transform .25s ease, box-shadow .25s ease; }
    .card-pop:hover { transform: translateY(-4px); box-shadow: 0 10px 30px -10px rgba(0,0,0,.3); }

    /* Smooth scrollbar for scrollable content */
    .scroll-smoothbar { scrollbar-width: thin; scrollbar-color: rgba(100,116,139,.6) transparent; }
    .scroll-smoothbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .scroll-smoothbar::-webkit-scrollbar-thumb { background: rgba(100,116,139,.5); border-radius: 9999px; }

    /* Shimmer skeleton */
    .shimmer{ position:relative; overflow:hidden; }
    .shimmer::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      animation: shimmer 1.2s infinite; }
    @keyframes shimmer{ 100%{ transform: translateX(100%);} }

    /* Tiny pulse for buttons on load */
    .pulse-in { animation: pulse-in 1s ease-out; }
    @keyframes pulse-in { 0%{transform:scale(.98);} 60%{transform:scale(1.02);} 100%{transform:scale(1);} }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 dark:from-slate-900 dark:via-slate-950 dark:to-black text-slate-900 dark:text-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-10">
    <header class="mb-8">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-tr from-indigo-600 to-fuchsia-500 shadow-md"></div>
        <div>
          <h1 class="text-2xl font-semibold tracking-tight">Upload & Image Summary</h1>
          <p class="text-sm text-slate-600 dark:text-slate-400">Single-page frontend for your DRF API.</p>
        </div>
      </div>
    </header>

    <!-- Upload Section -->
    <section class="glass rounded-2xl shadow-lg p-6 mb-8 border border-slate-200/60 dark:border-slate-800/60">
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label for="fileInput" class="block text-sm font-medium mb-2">Upload a file</label>
          <div id="dropzone" class="rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 p-8 text-center cursor-pointer hover:border-indigo-400 transition">
            <input id="fileInput" type="file" class="hidden" />
            <div class="flex flex-col items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 opacity-70"><path d="M12 16a1 1 0 0 1-1-1V8.41l-1.3 1.3a1 1 0 0 1-1.4-1.42l3-3a1 1 0 0 1 1.4 0l3 3a1 1 0 0 1-1.4 1.42L13 8.4V15a1 1 0 0 1-1 1Zm-6 4a4 4 0 0 1-4-4V9a4 4 0 0 1 4-4h1a1 1 0 1 1 0 2H6a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1a1 1 0 1 1 2 0v1a4 4 0 0 1-4 4H6Z"/></svg>
              <p class="text-sm">Drag & drop or <span class="font-semibold underline">browse</span></p>
            </div>
          </div>
          <div id="selectedFile" class="mt-3 text-xs text-slate-600 dark:text-slate-400"></div>
          <div class="mt-4 flex items-center gap-3">
            <button id="uploadBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50 disabled:cursor-not-allowed pulse-in">Upload</button>
            <div id="progressWrap" class="hidden w-full max-w-xs">
              <div class="h-2 rounded-full bg-slate-200 dark:bg-slate-800 overflow-hidden shimmer">
                <div id="progressBar" class="h-2 w-0 bg-gradient-to-r from-indigo-500 to-fuchsia-500 transition-all"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview -->
        <div class="w-full md:w-[320px]">
          <div class="text-sm font-medium mb-2">Preview</div>
          <div id="previewBox" class="aspect-square rounded-2xl border border-slate-200/60 dark:border-slate-800/60 overflow-hidden flex items-center justify-center bg-slate-50 dark:bg-slate-900">
            <span class="text-xs text-slate-500">No file selected</span>
          </div>
        </div>
      </div>
    </section>

    <!-- List Section -->
    <section class="glass rounded-2xl shadow-lg p-6 border border-slate-200/60 dark:border-slate-800/60">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Recent Uploads</h2>
        <div class="flex items-center gap-2">
          <input id="searchInput" type="text" placeholder="Search..." class="px-3 py-2 rounded-xl bg-white/70 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 text-sm w-56" />
          <button id="refreshBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm">Refresh</button>
        </div>
      </div>
      <div id="list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      <div id="emptyState" class="text-sm text-slate-500 py-6 hidden">No uploads yet.</div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toasts" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api";
    const toast = (msg, variant='info') => {
      const colors = { info:'bg-slate-900 text-white', ok:'bg-emerald-600 text-white', err:'bg-rose-600 text-white' };
      const el = document.createElement('div');
      el.className = `fade-in px-3 py-2 rounded-xl shadow ${colors[variant]||colors.info}`;
      el.textContent = msg;
      document.getElementById('toasts').appendChild(el);
      setTimeout(()=>el.remove(),3000);
    };

    const dropzone=document.getElementById('dropzone');
    const fileInput=document.getElementById('fileInput');
    const uploadBtn=document.getElementById('uploadBtn');
    const selectedFile=document.getElementById('selectedFile');
    const previewBox=document.getElementById('previewBox');
    const list=document.getElementById('list');
    const emptyState=document.getElementById('emptyState');
    const searchInput=document.getElementById('searchInput');
    const refreshBtn=document.getElementById('refreshBtn');
    const progressWrap=document.getElementById('progressWrap');
    const progressBar=document.getElementById('progressBar');
    let file=null;

    ['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();dropzone.classList.add('border-indigo-400');}));
    ['dragleave','drop'].forEach(evt=>dropzone.addEventListener(evt,e=>{e.preventDefault();dropzone.classList.remove('border-indigo-400');}));
    dropzone.addEventListener('drop',e=>{file=e.dataTransfer.files?.[0]||null;onFilePicked();});
    dropzone.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',()=>{file=fileInput.files?.[0]||null;onFilePicked();});

    function onFilePicked(){
      if(!file){
        previewBox.innerHTML='<span class="text-xs text-slate-500">No file selected</span>';
        selectedFile.textContent='';
        return;
      }
      selectedFile.textContent=`${file.name} • ${(file.size/1024).toFixed(1)} KB`;
      if(file.type.startsWith('image/')){
        const img=document.createElement('img');
        img.src=URL.createObjectURL(file);
        img.className='w-full h-full object-cover';
        previewBox.innerHTML='';previewBox.appendChild(img);
      } else previewBox.innerHTML='<span class="text-xs text-slate-500">(No preview)</span>';
    }

    uploadBtn.addEventListener('click',async()=>{
      if(!file)return toast('Select a file first','err');
      uploadBtn.disabled=true;progressWrap.classList.remove('hidden');progressBar.style.width='25%';
      try{
        const form=new FormData();form.append('file',file);
        const res=await fetch(`${API_BASE}/upload/`,{method:'POST',body:form});
        if(!res.ok)throw new Error('Upload failed');
        progressBar.style.width='75%';
        toast('Upload successful','ok');
        await loadItems();
        progressBar.style.width='100%';
      }catch(e){toast(e.message,'err');}
      finally{setTimeout(()=>{uploadBtn.disabled=false;progressWrap.classList.add('hidden');progressBar.style.width='0';},400);}
    });

    async function loadItems(){
      const res=await fetch(`${API_BASE}/upload/`);
      if(!res.ok)return toast('Failed to load items','err');
      const data=await res.json();
      const items=Array.isArray(data)?data:data.results||[];
      const query=searchInput.value.trim().toLowerCase();
      const filtered=query?items.filter(x=>((x.file||'')+JSON.stringify(x)).toLowerCase().includes(query)):items;
      list.innerHTML='';
      if(filtered.length===0){emptyState.classList.remove('hidden');return;}
      emptyState.classList.add('hidden');
      filtered.forEach(renderCard);
    }

    // ✅ Fix: Clean file URL from API (remove duplicate /uploads/)
    function cleanFileUrl(url){
      if(!url)return '';
      return url.replace('/uploads/uploads/','/uploads/');
    }

    function fileBadge(name='file'){
      const ext=(name.split('.').pop()||'file').toUpperCase();
      return `<span class="text-[10px] px-2 py-0.5 rounded-full border border-slate-300/70 dark:border-slate-700/70 bg-white/60 dark:bg-slate-900/50">${ext}</span>`
    }

    function renderCard(item){
      const isImage=/(jpe?g|png|gif|webp|bmp|svg)$/i.test(item.file||'');
      const url=cleanFileUrl(item.file);

      const card=document.createElement('div');
      card.className='fade-in card-pop border border-slate-200/60 dark:border-slate-800/60 rounded-2xl p-0 bg-white/70 dark:bg-slate-900/60 flex flex-col overflow-hidden';

      // Top media (BIG photo)
      const media=document.createElement('div');
      media.className='relative bg-slate-100 dark:bg-slate-800';
      media.style.minHeight='180px';
      if(isImage){
        media.innerHTML=`
          <img src="${url}" alt="preview" class="w-full h-56 object-cover select-none">
          <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent pointer-events-none"></div>
        `;
      } else {
        media.innerHTML=`
          <div class="h-56 flex items-center justify-center">
            <div class="h-16 w-16 rounded-2xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 opacity-70"><path d="M6 2a2 2 0 0 0-2 2v16.5c0 .4.46.64.8.4l2.9-1.93a2 2 0 0 1 1.12-.35H18a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H6Z"/></svg>
            </div>
          </div>`;
      }
      // Badge + timestamp overlay
      const overlay=document.createElement('div');
      overlay.className='absolute top-3 left-3 right-3 flex items-center justify-between text-xs text-white';
      overlay.innerHTML=`
        <div class="flex items-center gap-2">
          ${fileBadge(item.file||'file')}
          <span class="px-2 py-0.5 rounded-full bg-black/40">ID: ${item.id}</span>
        </div>
        <span class="px-2 py-0.5 rounded-full bg-black/40">${new Date(item.created_at).toLocaleString()}</span>`;
      media.appendChild(overlay);

      // Body
      const body=document.createElement('div');
      body.className='p-4 flex flex-col gap-3';

      const title=document.createElement('div');
      title.className='text-sm font-semibold truncate';
      title.textContent=(item.file||'').split('/').pop() || 'Untitled';

      const descBox=document.createElement('div');
      descBox.className='prose prose-sm dark:prose-invert max-w-none text-slate-800 dark:text-slate-200 bg-slate-50/70 dark:bg-slate-800/50 rounded-xl p-3 min-h-[72px] max-h-40 overflow-auto scroll-smoothbar';
      // Render markdown safely
      const md = item.description || 'No description yet.';
      descBox.innerHTML = DOMPurify.sanitize(marked.parse(md));

      // Actions
      const actions=document.createElement('div');
      actions.className='flex items-center gap-2';

      const openBtn=document.createElement('a');
      openBtn.href=url; openBtn.target='_blank';
      openBtn.className='px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm';
      openBtn.innerHTML='Open';

      const copyBtn=document.createElement('button');
      copyBtn.className='px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm';
      copyBtn.textContent='Copy Summary';
      copyBtn.addEventListener('click', async ()=>{
        try{
          const text = descBox.textContent.trim();
          await navigator.clipboard.writeText(text);
          toast('Summary copied','ok');
        }catch{ toast('Copy failed','err'); }
      });

      const summarizeBtn=document.createElement('button');
      summarizeBtn.className='px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm';
      summarizeBtn.textContent='Generate Summary';
      summarizeBtn.addEventListener('click',async()=>{
        summarizeBtn.disabled=true; summarizeBtn.textContent='Summarizing…';
        summarizeBtn.classList.add('shimmer');
        try{
          const res=await fetch(`${API_BASE}/upload/${item.id}/summary/`);
          const data=await res.json();
          const md = data.summary || 'No summary.';
          descBox.innerHTML = DOMPurify.sanitize(marked.parse(md));
          toast('Summary generated','ok');
        }catch(e){toast('Failed to summarize','err');}
        finally{ summarizeBtn.disabled=false; summarizeBtn.textContent='Generate Summary'; summarizeBtn.classList.remove('shimmer'); }
      });

      actions.appendChild(openBtn);
      actions.appendChild(copyBtn);
      actions.appendChild(summarizeBtn);

      body.appendChild(title);
      body.appendChild(descBox);
      body.appendChild(actions);

      card.appendChild(media);
      card.appendChild(body);

      list.appendChild(card);
    }

    searchInput.addEventListener('input',loadItems);
    refreshBtn.addEventListener('click',loadItems);
    loadItems();
  </script>
</body>
</html>